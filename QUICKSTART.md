# å¿«é€Ÿé–‹å§‹æŒ‡å—

## ğŸš€ 5 åˆ†é˜å¿«é€Ÿéƒ¨ç½²

æœ¬æŒ‡å—å¹«åŠ©æ‚¨åœ¨ 5 åˆ†é˜å…§å®Œæˆ RRDW æ”¶é›†å™¨çš„éƒ¨ç½²å’Œæ¸¬è©¦ã€‚

---

## æ­¥é©Ÿ 1: è§£å£“ç¸®ä¸¦éƒ¨ç½² (1 åˆ†é˜)

```bash
# è§£å£“ç¸®
unzip rrdw_collectors_code.zip
cd rrdw_code

# è‡ªå‹•éƒ¨ç½²ï¼ˆæ¨è–¦ï¼‰
sudo bash deploy_collectors.sh

# æŒ‰ Enter ä½¿ç”¨é è¨­è·¯å¾‘ /opt/isp_monitor
# ç­‰å¾…éƒ¨ç½²å®Œæˆ...
```

**é æœŸè¼¸å‡º**:
```
[1/5] å»ºç«‹ç›®éŒ„çµæ§‹...
[2/5] éƒ¨ç½²æ ¸å¿ƒæ¨¡çµ„...
[3/5] éƒ¨ç½²æ”¶é›†å™¨...
[4/5] è¨­å®šåŸ·è¡Œæ¬Šé™...
[5/5] æ¸¬è©¦æ¨¡çµ„åŒ¯å…¥...
âœ“ éƒ¨ç½²å®Œæˆï¼
```

---

## æ­¥é©Ÿ 2: ç’°å¢ƒé©—è­‰ (1 åˆ†é˜)

```bash
# åŸ·è¡Œå¿«é€Ÿé©—è­‰
cd /opt/isp_monitor
bash quick_test.sh

# æˆ–å¾ rrdw_code ç›®éŒ„
cd rrdw_code
bash quick_test.sh /opt/isp_monitor
```

**æª¢æŸ¥é …ç›®**:
- âœ“ Python 3 å·²å®‰è£
- âœ“ pysnmp å·²å®‰è£
- âœ“ rrdtool å·²å®‰è£
- âœ“ ç›®éŒ„çµæ§‹æ­£ç¢º
- âœ“ æ ¸å¿ƒæ¨¡çµ„å¯åŒ¯å…¥
- âœ“ æ”¶é›†å™¨å·²éƒ¨ç½²

å¦‚æœæœ‰éŒ¯èª¤ï¼Œè«‹å…ˆè§£æ±ºå†ç¹¼çºŒã€‚

---

## æ­¥é©Ÿ 3: è¨­å®šé…ç½® (1 åˆ†é˜)

```bash
cd /opt/isp_monitor/config

# è¤‡è£½é…ç½®ç¯„æœ¬
cp /path/to/rrdw_code/config.ini.example config.ini

# ç·¨è¼¯é…ç½®ï¼ˆä¸»è¦æª¢æŸ¥é€™äº›é …ç›®ï¼‰
vim config.ini
```

**å¿…è¦é…ç½®é …ç›®**:
```ini
[snmp]
default_community = public    # æ”¹æˆå¯¦éš›çš„ community

[snmp]
e320_timeout = 10            # E320 éœ€è¦è¼ƒé•·æ™‚é–“
```

å…¶ä»–å¯ä½¿ç”¨é è¨­å€¼ã€‚

---

## æ­¥é©Ÿ 4: æ¸¬è©¦ SNMP é€£ç·š (1 åˆ†é˜)

```bash
cd /opt/isp_monitor

# æ¸¬è©¦ E320 è¨­å‚™
python3 tools/test_snmp_connection.py \
  --host 61.64.191.78 \
  --timeout 10

# æ¸¬è©¦ MX240 è¨­å‚™
python3 tools/test_snmp_connection.py \
  --host 61.64.191.74
```

**é æœŸè¼¸å‡º**:
```
============================================================
SNMP é€£ç·šæ¸¬è©¦
============================================================
è¨­å‚™ IP:    61.64.191.78
Community:  public
Timeout:    10s
============================================================

æŸ¥è©¢ sysDescr (1.3.6.1.2.1.1.1.0)...
âœ“ é€£ç·šæˆåŠŸï¼

ç³»çµ±æè¿°:
Juniper Networks, Inc. e320 ...

è¨­å‚™é¡å‹: E320 (DeviceType=1)
å»ºè­° timeout: 10 ç§’
ä»‹é¢æ ¼å¼: ge-slot/port/pic.vci

æŸ¥è©¢ä»‹é¢æ•¸é‡...
âœ“ ä»‹é¢æ•¸é‡: 150

æŸ¥è©¢ä»‹é¢æ¸…å–®ï¼ˆé¡¯ç¤ºå‰ 10 å€‹ï¼‰...
     1: ge-1/2/0.3490
     2: ge-1/2/0.3491
     ...
```

---

## æ­¥é©Ÿ 5: ç”¢ç”Ÿ Map æª”æ¡ˆç¯„æœ¬ (1 åˆ†é˜)

### æ–¹æ³• A: è‡ªå‹•ç”¢ç”Ÿï¼ˆæ¨è–¦ï¼‰

```bash
cd /opt/isp_monitor

# E320 è¨­å‚™
python3 tools/generate_map_template.py \
  --host 61.64.191.78 \
  --type 1 \
  --timeout 10 \
  --output config/maps/map_61.64.191.78.txt

# MX240 è¨­å‚™
python3 tools/generate_map_template.py \
  --host 61.64.191.74 \
  --type 3 \
  --output config/maps/map_61.64.191.74.txt
```

**é æœŸè¼¸å‡º**:
```
æ­£åœ¨æŸ¥è©¢è¨­å‚™ 61.64.191.78 çš„ä»‹é¢...
âœ“ æ‰¾åˆ° 150 å€‹ä»‹é¢
âœ“ æ‰¾åˆ° 45 å€‹æœ‰æ•ˆ VLAN ä»‹é¢

ç”¢ç”Ÿ Map æª”æ¡ˆ: config/maps/map_61.64.191.78.txt
âœ“ Map æª”æ¡ˆå·²ç”¢ç”Ÿ
  åŒ…å« 20 ç­†ç¯„æœ¬è³‡æ–™

è«‹ç·¨è¼¯æ­¤æª”æ¡ˆä¸¦è¨­å®š:
  1. å¯¦éš›çš„ UserID
  2. æ­£ç¢ºçš„é »å¯¬
  3. å¯¦éš›çš„ AccountID
```

### æ–¹æ³• B: æ‰‹å‹•å»ºç«‹

```bash
cd /opt/isp_monitor/config/maps

# è¤‡è£½ç¯„æœ¬
cp /path/to/rrdw_code/map_example.txt map_61.64.191.78.txt

# ç·¨è¼¯ä¸¦å¡«å…¥å¯¦éš›è³‡æ–™
vim map_61.64.191.78.txt
```

**æ ¼å¼**:
```
# UserID,Slot_Port_VPI_VCI,Download_Upload,AccountID
user001,1_2_0_3490,102400_40960,0912345678
user002,1_2_0_3491,51200_10240,0913345678
```

**âš ï¸ æ³¨æ„**: å¿…é ˆä½¿ç”¨åº•ç·š `_` åˆ†éš”ï¼

---

## æ­¥é©Ÿ 6: æ¸¬è©¦æ”¶é›†å™¨ (1 åˆ†é˜)

```bash
cd /opt/isp_monitor/collectors

# æ¸¬è©¦ E320
python3 collector_e320.py \
  --ip 61.64.191.78 \
  --map ../config/maps/map_61.64.191.78.txt \
  --debug

# æ¸¬è©¦ MX240
python3 collector_mx240.py \
  --ip 61.64.191.74 \
  --map ../config/maps/map_61.64.191.74.txt \
  --debug
```

**é æœŸè¼¸å‡º**:
```
============================================================
E320 æµé‡æ”¶é›†å™¨å•Ÿå‹•
è¨­å‚™ IP: 61.64.191.78
Map æª”æ¡ˆ: ../config/maps/map_61.64.191.78.txt
============================================================
INFO - æ”¶é›†å™¨åˆå§‹åŒ–: E320 - 61.64.191.78
INFO - æ¸¬è©¦ SNMP é€£ç·š: 61.64.191.78
INFO - é€£ç·šæˆåŠŸ: Juniper Networks...
INFO - è®€å– Map æª”æ¡ˆ: ...
INFO - è¼‰å…¥ 20 ç­†ç”¨æˆ¶è³‡æ–™
INFO - é–‹å§‹æ”¶é›† 20 å€‹ç”¨æˆ¶
INFO - æ”¶é›†å®Œæˆ: æˆåŠŸ=20, å¤±æ•—=0, è€—æ™‚=15.2ç§’, æˆåŠŸç‡=100.0%

============================================================
æ”¶é›†çµ±è¨ˆ
============================================================
ç¸½ç”¨æˆ¶æ•¸: 20
æˆåŠŸ: 20
å¤±æ•—: 0
è€—æ™‚: 15.2 ç§’
æˆåŠŸç‡: 100.0%
============================================================
```

---

## æ­¥é©Ÿ 7: é©—è­‰ RRD æª”æ¡ˆ

```bash
# æª¢æŸ¥ RRD æª”æ¡ˆ
ls -lh /opt/isp_monitor/data/user/

# æŸ¥çœ‹ RRD è³‡è¨Š
rrdtool info /opt/isp_monitor/data/user/user001.rrd

# æŸ¥çœ‹æœ€æ–°æ•¸æ“š
rrdtool lastupdate /opt/isp_monitor/data/user/user001.rrd
```

**é æœŸè¼¸å‡º**:
```
-rw-r--r-- 1 root root 90K Nov 19 10:30 user001.rrd
-rw-r--r-- 1 root root 90K Nov 19 10:30 user002.rrd
...

# lastupdate è¼¸å‡º
1732000200: 12345678 9876543
```

---

## âœ… å®Œæˆï¼

å¦‚æœä»¥ä¸Šæ‰€æœ‰æ­¥é©Ÿéƒ½æˆåŠŸï¼Œæ­å–œæ‚¨å·²å®Œæˆéƒ¨ç½²ï¼

### å¾ŒçºŒå·¥ä½œ

1. **å»ºç«‹æ›´å¤š Map æª”æ¡ˆ**
   - ç‚ºæ¯å€‹ BRAS è¨­å‚™å»ºç«‹å°æ‡‰çš„ map_<IP>.txt

2. **è¨­å®šå®šæ™‚åŸ·è¡Œ**
   ```bash
   crontab -e
   
   # æ¯ 20 åˆ†é˜åŸ·è¡Œä¸€æ¬¡
   */20 * * * * cd /opt/isp_monitor/collectors && python3 collector_e320.py --ip 61.64.191.78 --map ../config/maps/map_61.64.191.78.txt >> ../logs/e320.log 2>&1
   ```

3. **ç›£æ§æ—¥èªŒ**
   ```bash
   tail -f /opt/isp_monitor/logs/*.log
   ```

---

## ğŸ†˜ é‡åˆ°å•é¡Œï¼Ÿ

### å¸¸è¦‹å•é¡Œå¿«é€Ÿè§£æ±º

**Q1: SNMP é€£ç·šå¤±æ•—**
```bash
# æª¢æŸ¥ç¶²è·¯
ping <DEVICE_IP>

# ä½¿ç”¨ snmpget æ¸¬è©¦
snmpget -v 2c -c public <DEVICE_IP> 1.3.6.1.2.1.1.1.0

# E320 éœ€è¦è¼ƒé•· timeout
snmpget -v 2c -c public -t 10 <E320_IP> 1.3.6.1.2.1.1.1.0
```

**Q2: Map æª”æ¡ˆæ ¼å¼éŒ¯èª¤**
```bash
# æª¢æŸ¥æ˜¯å¦ä½¿ç”¨åº•ç·šè€Œéæ–œç·š
grep -E "[0-9]/[0-9]" map_file.txt   # ä¸æ‡‰è©²æœ‰è¼¸å‡º

# æ­£ç¢ºæ ¼å¼
1_2_0_3490,102400_40960

# éŒ¯èª¤æ ¼å¼
1/2/0/3490,102400/40960
```

**Q3: æ‰¾ä¸åˆ°æ¨¡çµ„**
```python
ModuleNotFoundError: No module named 'core'
```

**è§£æ±º**:
```bash
# ç¢ºèªåœ¨æ­£ç¢ºç›®éŒ„
cd /opt/isp_monitor

# æˆ–è¨­å®š PYTHONPATH
export PYTHONPATH=/opt/isp_monitor:$PYTHONPATH
```

### è©³ç´°æ–‡ä»¶

- **TESTING_GUIDE.md** - å®Œæ•´æ¸¬è©¦æŒ‡å—ï¼ˆ31 KBï¼Œè¶…è©³ç´°ï¼‰
- **README.md** - ç¨‹å¼ç¢¼ä½¿ç”¨èªªæ˜
- **COLLECTORS_DELIVERY.md** - äº¤ä»˜ç¸½çµ

### å–å¾—å”åŠ©

```bash
# åŸ·è¡Œé™¤éŒ¯æ¨¡å¼
python3 collector_xxx.py --ip <IP> --map <MAP> --debug

# æŸ¥çœ‹æ—¥èªŒ
tail -f /opt/isp_monitor/logs/collector.log
```

---

## ğŸ“Š ä¸‹ä¸€æ­¥

å®ŒæˆåŸºæœ¬éƒ¨ç½²å¾Œï¼Œæ‚¨å¯ä»¥ï¼š

1. âœ… éƒ¨ç½²æ‰€æœ‰è¨­å‚™çš„æ”¶é›†å™¨
2. âœ… è¨­å®š Cron å®šæ™‚åŸ·è¡Œ
3. âœ… å»ºç«‹ BRAS-Map.txt çµ±ä¸€èª¿åº¦
4. âœ… é–‹ç™¼ Dispatcher è‡ªå‹•èª¿åº¦ç³»çµ±
5. âœ… å»ºç«‹å ±è¡¨ç³»çµ±

ç¥æ‚¨ä½¿ç”¨é †åˆ©ï¼ğŸ‰

---

**æç¤º**: å°‡æ­¤å¿«é€Ÿé–‹å§‹æŒ‡å—åŠ å…¥æ›¸ç±¤ï¼Œæ–¹ä¾¿æ—¥å¾Œåƒè€ƒã€‚
